{% extends "base.html" %}
{% load crispy_forms_tags %}
{% block 'content' %}
<h1 class="title">
    Edit Run
</h1>
<form method="POST" action=".">
    {% csrf_token %}
    {{ run_form|crispy }}
    <h2 class="title">Lanes</h2>
    <div id="lanes-container">
        {{ lane_formset | crispy }}
    </div>
    <a class="btn btn-success" id="add-lane">Add Lane</a>
    <input class="btn btn-primary" type="submit" value="Submit" />
</form>

<script>
let currentLane = {% if run_form.instance %}{{ run_form.instance.ordered_lanes.count }}{% else %}1{% endif%};

$(document).ready(function() {
        let formIndex = $('#lanes-container .multiField').length - 1; // Get the number of current forms
        
        $('#add-lane').on('click', function() {
            // Clone the last form in the formset
            let newForm = $('#lanes-container .multiField').last().clone();
            currentLane++;
            // Reset input values (optional)
            newForm.find('input, textarea, select').val('');
            // Update the form's IDs, names, and management form fields
            newForm.find('input, textarea, select').each(function() {
                let name = $(this).attr('name');
                name = name.replace('-' + (formIndex - 1) + '-', '-' + (formIndex+1) + '-');
                $(this).attr('name', name);
                $(this).attr('id', 'id_' + name);
                if (name.indexOf('lane_number') > 0) {
                    $(this).val(currentLane)
                }
            });
            newForm.find('.lane_number').html(currentLane);
            // Add the new form to the container
            $('#lanes-container').append(newForm);
            formIndex++;
            console.log('formIndex', formIndex)

            // Update the management form's total form count
            $('#id_lanes-TOTAL_FORMS').val(formIndex);
        });
    });
</script>
<style>
.multiField {
  display: flex;
  display: -webkit-flex;
  align-items: flex-start;
  -webkit-align-items: flex-start;
}
.multiField field {
    display: inline-block;
}
</style>
{% endblock %}