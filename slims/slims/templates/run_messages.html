{% extends "base.html" %}
{% load crispy_forms_tags %}
{% block 'content' %}
<h3 class="card-title"><a href="{% url 'runs' %}">Runs</a> / <a href="{% url 'run' pk=run.pk %}">{{run}}</a> / Messages</h3>
<div class="card mt-2">
    <div class="card-body">
        {{data}}
        {% if messages %}
        {% for submission, message, success in messages %}
        <div class="alert {% if form.cleaned_data.test %}alert-info{% elif success %}alert-success{% else %}alert-danger{% endif %}" role="alert">
            <h4>{% if form.cleaned_data.test %}(TEST) {% endif %}Submission: {{submission}}</h4>
            <pre>{{message}}</pre>
        </div>
        {% endfor %}
        {% endif %}
        {{messages}}
        <form method="POST">
            {% for field in form %}
                {% if field.name != 'pools' %}
                    {{ field|as_crispy_field }}
                {% endif %}
            {% endfor %}
            <table class="table table-striped">
                <thead>
                    <tr><th><label><input type="checkbox" id="selectAll"/> Select</label></th><th>Unit</th><th>PI/Group</th>{% if user.is_staff %}<th>Submission</th>{% endif %}<th>Project ID</th><th>Pool Dir</th><th>Description</th>{% if user.is_staff%}<th><a href="{% url 'run_data' pk=run.pk %}">Data Directories</a></th>{% endif %}<th>Controls</th></tr>
                </thead>
                <tbody>
                    {% for checkbox, l in form.get_pools %}
                        {% if l.submission %}
                        <tr submission="{{l.submission.id}}">
                            <td class="pool-select">{{checkbox.tag}}</td>
                            <td>{{l.lane_number}}</td>
                            <td>{{l.pi_name}}</td>
                            {% if user.is_staff %}
                            <td>{% if l.submission %}<a href="{% url 'submission' pk=l.submission.pk %}">{{l.submission}}</a>{% endif %}</td>
                            {% endif %}
                            <td>{{l.project_id}}</td>
                            <td>{{l.lane_dir}}</td>
                            <td>{{l.description}}</td>
                            <td>
                                {% for status, directories in l.grouped_directories.items %}
                                    <span class="status-{{status}}">{{directories|length}} {{status}}</span>{% if not forloop.last %}, {% endif %}</div>
                                {% endfor %}
                            </td>
                            <td>{% if l.data_url %}<a href="{{l.data_url}}" class="btn btn-primary">Data</a>{% endif %}</td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
            {% csrf_token %}
            <button class="btn btn-primary">Submit</button>
        </form>
    </div>
</div>
<script>
    $(document).ready(function() {
        $('#selectAll').change(function(data, event){
            $('.pool-select input').prop('checked', this.checked);
        })
    });
</script>
{% endblock %}